<!DOCTYPE html>
<html> 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">

<style type="text/css">
table#groupChatBox,table#mediaConfTable,table#mediaConfWindows, table#dialInMediaConfTable {
	padding: 0px;
	border: 1px solid black;
}

table#communicationBox {
	padding: 0px;
	border: 1px solid darkgray;
}

.offlineStatus {
	color: lightgray;
	border: 1px solid darkgray;
}

.normalStatus {
	color: darkblue;border: 1px solid black;
}

.errorStatus {
	color: red;
	border: 1px solid black;
}

.contrast{-webkit-filter:contrast(8);-moz-filter:contrast(8);-o-filter:contrast(8);-ms-filter:contrast(8);filter:contrast(8)}
.grayscale{-webkit-filter:grayscale(1);-moz-filter:grayscale(1);-o-filter:grayscale(1);-ms-filter:grayscale(1);filter:grayscale(1)}

/*.table, tr, td {border: 1px solid black;}*/
</style>

<script src="./jquery.min.js"></script>
<script type="text/javascript" src="./WCGapi_apigee.js"></script>

<script type="text/javascript">
	
	window.onload = function() {
		window.onbeforeunload = function(){
			if( typeof service === 'undefined'){
				return null;
			}
			else if(service != null && (service.state == 2 || service.state == 1)){
				console.log(service.state);
				return "Make sure you logout before you leave !";
			}
		}
					
		var url = document.getElementById("url");
		var turn = document.getElementById("turn");
		var login = document.getElementById("login");
		var number = document.getElementById("number");
		var token = document.getElementById("token");
		var password = document.getElementById("password");
		var genToken = document.getElementById("genToken");		
		var register = document.getElementById("register");
		var unregister = document.getElementById("unregister");
		var clientStatus = document.getElementById("clientStatus");

		var localStream= null;
		var remoteStream= null;
		var service = null;

		function disabling(element) {
			document.getElementById(element).setAttribute("disabled",
					"disabled");
		}

		function updateclientStatusError(text) {
			while (clientStatus.childNodes.length >= 1) {
				clientStatus.removeChild(clientStatus.firstChild);
			}
			clientStatus.appendChild(clientStatus.ownerDocument
					.createTextNode("  " + text));
			clientStatus.className = "errorStatus";
		}

		function updateclientStatus(text) {
			clientStatus.className = "normalStatus";
			while (clientStatus.childNodes.length >= 1) {
				clientStatus.removeChild(clientStatus.firstChild);
			}
			clientStatus.appendChild(clientStatus.ownerDocument
					.createTextNode("  " + text));
		}

		function setclientStatusColor(color) {
			clientStatus.style.color = color;
		}

		function enabling(element) {
			document.getElementById(element).removeAttribute("disabled");
		}

		genToken.onclick = function() {
			if(login.value == "")
			{
				updateclientStatus("Missing login id to generate Token");
				return;
			}
			updateclientStatus("Generating Token ...");
			var domain= url.value.substring(7);
			domain= domain.substr(0, domain.indexOf("/"));

			xmlHttp = new XMLHttpRequest();
			var apiGw_url= "http://" + apig.value +
			"/Simulated/Generate/AccessToken?external_id=" + login.value + "&virtual_tn=" +number.value;
			xmlHttp.open( "GET", apiGw_url, true );
			xmlHttp.setRequestHeader('Cache-Control', 'no-cache');
			xmlHttp.setRequestHeader('Pragma', 'no-cache');
			xmlHttp.onreadystatechange = function() {
				
				if (this.readyState == 4) {
					// Success response 200 OK
					if (this.status == 200) {
						token.value= this.responseText;
						updateclientStatus("Token generated !");
					} else {
						updateclientStatusError("Token generation fail: " + this.responseText);
					}
				}
			}
			xmlHttp.withCredentials = true;
			xmlHttp.send( null );
		};

		// User login
		register.onclick = function() {
			// Media service
			var wcgUrl= url.value;
			if(token.value != ""){
				//service = new MediaServices(wcgUrl, login.value, "oauth " + token.value,"audio,video,chat");
				service = new MediaServices(wcgUrl, login.value, token.value,"audio,video,chat");
			} else {
				service = new MediaServices(wcgUrl, login.value, password.value,"audio,video,chat");
			}
					
			service.turnConfig = turn.value;
			service.onclose = serviceOnClose;
			service.onerror = serviceOnError;
			service.oninvite = serviceOnInvite;
			service.onready = serviceOnReady;
			service.onstatechange = serviceOnStateChange;
			service.oninstantmessage = serviceOnIM;
			updateclientStatus("Login ...");
		};

		unregister.onclick = function() {
			service.unregister();
			enabling("register");
			disabling("unregister");
			disablingCreateCall();
			disablingCallAction();
			disabling("sendMsg");
			disabling("sendIM");
			disabling("groupChatButton");
			disabling("sendMedia");
			disabling("sendFile");
			disabling("sendGroupMsg");
			disabling("fileMedia");
			disabling("quitGroupChat");
			subject.value = "";
			participants.value = "";
			groupChatText.value = "";
			chatText.value = "";
			fileMedia.value = "";
			videoWindows.setAttribute("hidden", "hidden");
			downloadedImg.style.visibility = "hidden";
			call = chat = service = null;
			callRecipient.value = "";
			removeNotification(transferNotification);
			removeNotification(callNotification);
			downloadedFile.style.visibility= "hidden";
			updateclientStatus("Logout ...");
		};

		///////////////////////////////////////// Call /////////////////////////////////////////////////////////////////				

		var call = null;
		var callRecipient = document.getElementById("callRecipient");
		var calling = document.getElementById("calling");
		var voiceCalling = document.getElementById("voiceCalling");		
		var callNotification = document.getElementById("callNotification");
		var rejectCall = document.getElementById("rejectCall");
		var endCall = document.getElementById("endCall");

		var videoWindows = document.getElementById("videoWindows");
		var localvideo = document.getElementById("selfView");
		var remotevideo = document.getElementById("remoteView");

		localvideo.onclick = function() {
			var el = localvideo;
			if(el.className =='')
			{
			el.classList.add('invert');
			} else if(el.className == 'invert'){
			  el.className = 'grayscale';
			  }else {
			  el.className = '';
			}
		}

		function createACall(withUser, media) {
			call = service.createCall(withUser, media);
			call.onaddstream = callOnAddStream;
			call.onbegin = callOnBegin;
			call.onend = callOnEnd;
			call.onerror = callOnError;
			call.onremovestream = callOnRemoveStream;
			call.onstatechange = callOnStateChange;
			call.ring();
		}

		// Create a video call and calling the other person
		calling.onclick = function() {
			if (callRecipient.value != ""
					&& callRecipient.value != callRecipient.defaultValue) {
				createACall(callRecipient.value, {audio : true,	video : true});
				updateclientStatus("Calling \"" + callRecipient.value + "\"");
				enabling("endCall");
				disablingCreateCall();
			} else {
				updateclientStatus("Call missing address, friend is only an example");
				clientStatus.className = "errorStatus";
			}
		};

		// Create a voice call and calling the other person
		voiceCalling.onclick = function() {
			if (callRecipient.value != ""
					&& callRecipient.value != callRecipient.defaultValue) {
				createACall(callRecipient.value, {audio : true,	video : false});
				updateclientStatus("Calling \"" + callRecipient.value + "\"");
				enabling("endCall");
				disablingCreateCall();
			} else {
				updateclientStatus("Call missing address, friend is only an example");
				clientStatus.className = "errorStatus";
			}
		};
		  
		holdCall.onclick = function() {
			updateclientStatus("Put call on hold !");
			disabling("resumeCall");
			disabling("transferCall");
			disabling("transferTarget");			
			disabling("holdCall");
			call.hold();
		}	
		
		resumeCall.onclick = function() {
			updateclientStatus("Resume call !");
			disabling("holdCall");
			disabling("resumeCall");
			disabling("transferCall");
			disabling("transferTarget");
			call.resume();
		}		
		
		transferCall.onclick = function() {
			if (transferTarget.value != ""){
				updateclientStatus("Transfering call !");
			}
			
			if(call.state == Call.State.HOLDING){
				call.transferto(transferTarget.value);
			}
		}		
				
		function callOnAddStream(event) {
			if(event.call.mediaType.video && event.call.mediaType.video == true ){
				videoWindows.removeAttribute("hidden");
			}
			if (event.call.localStreams) {
				console.log("[Call] Local stream added");
				var url = webkitURL.createObjectURL(event.call.localStreams[0]);
				localvideo.style.opacity = 1;
				localvideo.src = url;
				localStream= event.call.localStreams[0];
			}
			if (event.call.remoteStreams) {
				console.log("[Call] Remote stream added");
				var url = webkitURL.createObjectURL(event.stream);
				remotevideo.style.opacity = 1;
				remotevideo.src = url;
				remoteStream= event.call.remoteStreams[0];
			}
		}
		
		// End call
		endCall.onclick = function() {
			call.end();
			resetCallStates();
			updateclientStatus("Terminating call");
//			localStream.stop(); 
			localStream= null;
//			remoteStream.stop(); 
			remoteStream= null;
		};

		function resetCallStates() {			
			enablingCreateCall();
			disablingCallAction();	
			removeNotification(callNotification);
			videoWindows.setAttribute("hidden", "hidden");
			localvideo.src = "";
			call = null;
		}

		function callOnBegin(event) {
			updateclientStatus("Call connected");
			disablingCreateCall();
			enabling("endCall");
			enabling("holdCall");
			localvideo.style.webkitTransform = "rotateY(180deg)";
			disabling("acceptCall");
			disabling("rejectCall");
			console.log("[Call] Call has started");
		}

		function callOnEnd(event) {
			updateclientStatus(event.reason);
			resetCallStates();
			disabling("acceptCall");
			console.log("[Call] Call has ended");
		}

		function callOnError(event) {
			var reason;
			switch(event.reason){
			case 	Call.Error.NETWORK_FAILURE: 
			reason= "Network Failure"; break;
			case 	Call.Error.PEER_CONNECTION: 
			reason= "Peer connection Failure"; break;
			case 	Call.Error.USER_MEDIA: 
			reason= "User media Failure"; break;
			case 	Call.Error.INVALID_USER: 
			reason= "Invalid user"; break;
			default:
			reason= "Unknown problem";
			}
		
			endCall.onclick();
			updateclientStatus("Call Error: "+ reason);
			clientStatus.className = "errorStatus";
			console.log("[Call] Error: " + reason + " " + event.target);
		}

		function callOnRemoveStream(event) {
			console.log("[Call] Stream removed");
		}

		function callOnStateChange(event) {
			console.log("[Call] State changed: " + ((call == null)?"ENDED":call.getStringState()));			
			if(event.state == Call.State.WAITING){
				disabling("resumeCall");
				disabling("transferCall");
				disabling("transferTarget");			
				disabling("holdCall");
			} else if(event.state == Call.State.ONGOING){
				disabling("resumeCall");
				disabling("transferCall");
				disabling("transferTarget");			
				enabling("holdCall");
			} else if(event.state == Call.State.HOLDING){
				enabling("resumeCall");
				enabling("transferCall");
				enabling("transferTarget");			
				disabling("holdCall");
			}else if(event.state == Call.State.TRANSITION){
				disabling("resumeCall");
				disabling("transferCall");
				disabling("transferTarget");			
				disabling("holdCall");
			}
		}

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				

		/////////////////////////////////////////Dial-in Conference/////////////////////////////////////////////////////////////////				
		var createConf = document.getElementById("createConf");
		var confRecipient = document.getElementById("confRecipient");
		var connectConf = document.getElementById("connectConf");
		var quitConf = document.getElementById("quitConf");

		// Create a conference and start the conference
		createConf.onclick = function() {
			call = service.createConference({
				audio : true,
				video : true
			});
			call.onaddstream = confOnAddStream;
			call.onbegin = confOnBegin;
			call.onend = confOnEnd;
			call.onerror = confOnError;
			call.onremovestream = confOnRemoveStream;
			call.onstatechange = confOnStateChange;
			call.onjoin = confOnJoin;
			call.onleave = confOnLeave;

			// Starts the conference, and automatically joins it (moderator)
			call.begin(function(event) {
				if (event.success == true) {
					console.log("[Conference] Conference started with ID: "
							+ call.confID);
					confRecipient.value = call.confID;
				} else if (event.failure == true) {
					console.log("[Conference] Conference begin failure");
				}
			});
			updateclientStatus("Creating conference...");
			enabling("quitConf");
			disabling("connectConf");
		};
		

		// Create a call and connectConf the other person
		connectConf.onclick = function() {
			createACall("conf:" + confRecipient.value);
			updateclientStatus("Connecting to conference \""
					+ confRecipient.value + "\"");
			enabling("quitConf");
			disablingCreateCall();
		};

		quitConf.onclick = function() {
			endCall.onclick();
			updateclientStatus("Terminating conference call");
		};

		function confOnAddStream(event) {
			videoWindows.removeAttribute("hidden");
			if (event.call.localStreams) {
				console.log("[Conference] Local stream added");
				var url = webkitURL.createObjectURL(event.call.localStreams[0]);
				localvideo.style.opacity = 1;
				localvideo.src = url;
			}
			if (event.call.remoteStreams) {
				console.log("[Conference] Remote stream added");
				var url = webkitURL.createObjectURL(event.stream);
				remotevideo.style.opacity = 1;
				remotevideo.src = url;
			}
		}

		function confOnBegin(event) {
			updateclientStatus("Connected to conference !");
			disablingCreateCall();
			enabling("quitConf");
			enabling("quitMediaConf");
			enabling("inviteParticipant");
			console.log("[Conference] Conference started with ID: " + call.confID);
			confRecipient.value = call.confID;
			console.log("[Conference] The conference has been started.");
		}

		function confOnJoin(event) {
			console.log("[Conference] I have joined the conference");
		}

		function confOnLeave(event) {
			console.log("[Conference] I have left the conference");
		}

		function confOnEnd(event) {
			resetCallStates();
			updateclientStatus("Conference has ended!");
			console.log("[Conference] The conference has ended");
		}

		function confOnRemoveStream(event) {
			console.log("[Conference] Remote stream removed");
		}

		function confOnStateChange(event) {
			console.log("[Conference] State changed: " + event.state);
		}

		function confOnError(event) {
			console.log("[Conference] Error");
		}

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				

		/////////////////////////////////////////// CHAT //////////////////////////////////////////////////////////////////////
		//var composing = document.getElementById("composing");
		var chatText = document.getElementById("chatText");
		var sendMsg = document.getElementById("sendMsg");
		var sendIM = document.getElementById("sendIM");
		var sendMedia = document.getElementById("sendMedia");
		var message = document.getElementById("message");
		var fileMedia = document.getElementById("fileMedia");
		var downloadedImg = document.getElementById("downloadedImg");
		var chat = null;

		//			  var fileBlobs = [];
		//			  function handleFileSelect(event) {
		//			    var files = event.target.files; // FileList object

		//			    // files is a FileList of File objects. You may now read their contents
		//			    var reader = new FileReader();
		//			    for (var i = 0, f; f = files[i]; i++) {
		//			      fileBlobs.push(reader.readAsBinaryString(f));
		//			    }
		//			  }    
		//			  document.getElementById('files').addEventListener('change', handleFileSelect, false);

		function createChat(chatWith) {
			if (chat == null) {
				if (chatWith != "" && chatWith != callRecipient.defaultValue) {
					chat = service.createChat(chatWith);
					callRecipient.value = chatWith;
				} else {
					updateclientStatusError("Chat missing address, friend is only an example");
					return;
				}
			}
			chat.onbegin = chatOnBegin;
			chat.onmessage = chatOnMessage;
			chat.oncomposing = chatIsComposing;
			chat.onerror = chatOnError;
			chat.onstatechange = chatOnStateChange;
		}

		sendMsg.onclick = function() {
			var msg = message.value;
			if (msg != "") {
				createChat(callRecipient.value);
				if (chat != null) {
					chatText.value += "Me: " + msg + "\n";
					chatText.scrollTop = chatText.scrollHeight;
					chat.send(msg);
					message.value = "";
					removeIsComposingText();			
					updateclientStatus("Message sent !");
					message.focus();
				}
			}
		};

		// Send is composing
		message.onpaste  = function(event){
			if(chat != null){
				chat.typing();
			}
		};
		message.onkeypress = function(event){
			if(chat != null && event.keyCode != 13){
				chat.typing();
			}
		};

		sendMedia.onclick = function() {
			if (fileMedia.value != "") {
				createChat(callRecipient.value);
				if (chat != null) {
					try {
						chat.sendMedia(fileMedia.files[0]);
						fileMedia.value = "";
						disabling("sendMedia");
						disabling("sendFile");
						updateclientStatus("Media " + fileMedia.value + " sent !");
						message.focus();
					} catch (error) {
						updateclientStatusError(error.message);
					}
				}
			}
		};

		function chatOnMessage(event) {
			if (event.message) {
				if (callRecipient.value == ""
						|| callRecipient.value == callRecipient.defaultValue) {
					callRecipient.value = event.from;
				}
				removeIsComposingText();	
				updateclientStatus("Received chat message !");
				chatText.value += event.from + ": " + event.message + "\n";
				chatText.scrollTop = chatText.scrollHeight;
			} else {//media 
				updateclientStatus("Received image !");
				downloadedImg.style.visibility = "visible";
				downloadedImg.setAttribute("src", event.media);
			}
		}

		function chatOnBegin(event) {
			updateclientStatus("Started chat...");
		}

		function chatIsComposing(event) {
			var message = event.from + " is typing...";
			isComposing.innerHTML= '<font size="1">' + message + '</font>';
			setTimeout(removeIsComposingText, (event.refresh *1000)-500);
		}

		function removeIsComposingText() {
			isComposing.innerHTML= "&nbsp;";
		}
				
		function chatOnError(event) {
			if (event.reason == Chat.Error.INVALID_USER) {
				updateclientStatusError("Chat error: Invalid remote user");
				chat = null;
			} else if (event.reason == Chat.Error.USER_NOT_ONLINE) {
				updateclientStatusError("Chat error: Remote user offline");
				chat = null;
			} else {
				updateclientStatusError("Chat error: " + event.reason);
			}

		}

		function chatOnStateChange(event) {
			console.log("[Chat] State changed: " + event + " " + event.state);
		}

		/////////////////////////////////////////////GROUP CHAT ///////////////////////////////////////////////////////////////
		var groupChat = null;
		var groupChatButton = document.getElementById("groupChatButton");
		var sendGroupMsg = document.getElementById("sendGroupMsg");
		var subject = document.getElementById("subject");
		var participants = document.getElementById("participants");
		var declineGroup = document.getElementById("declineGroup");
		var acceptGroup = document.getElementById("acceptGroup");

		groupChatButton.onclick = function() {
			disabling("groupChatButton");
			groupChat = service.createGroupChat(subject.value,
					participants.value.replace(/\s/g, '').split(','));
			groupChat.onbegin = groupchatOnBegin;
			groupChat.onend = groupchatOnEnd;
			groupChat.onmessage = groupchatOnMessage;
			groupChat.oncomposing = groupchatIsComposing;
			groupChat.onerror = groupchatOnError;
			groupChat.onstatechange = groupchatOnStateChange;
			groupChat.onupdate = groupchatOnUpdate;
			groupChat.start();
			updateclientStatus("Waiting for participans to join group...");
			groupChatText.value= "";

		};

		quitGroupChat.onclick = function(){
			groupChat.leave();
			groupChatEnded();
		};
		
		function groupchatOnBegin(event) {
			updateclientStatus("Group chat active!");
			enabling("sendGroupMsg");
			enabling("quitGroupChat");
		}

		sendGroupMsg.onclick = function() {
			var msg = groupMessage.value;
			if (msg != "") {
					groupChatText.value += "Me: " + msg + "\n";
					groupChat.send(msg);
					groupMessage.value = "";
					updateclientStatus("Message sent !");
					groupMessage.focus();
			}
		};

		function groupchatOnMessage(event) {
			if (event.message) {
				updateclientStatus("Received chat message !");
				groupChatText.value += event.from + ": " + event.message + "\n";
			}
		}

		function groupchatOnEnd(event) {
			groupChatEnded();
		}

		function groupchatOnDecline(event) {
			console.log("Group declined !");
		}

		function groupchatIsComposing(event) {
			updateclientStatus("Started chat...");
		}

		function groupchatOnError(event) {
			updateclientStatus("Group chat error: " + event.reason);
		}

		function groupchatOnStateChange(event) {
			console.log("[Group] State changed: " + event.state);
			if(event.state == 2) {//ended
				groupChatEnded();
			}
		}

		function groupchatOnUpdate(event) {
			if (event.members[0].status == "disconnected") {
				console.log(event.members[0].entity + " has disconnected from the chat");
			}
			else if (event.members[0].status == "connected") {
				updateclientStatus(event.members[0].entity + " is connected to chat");
			}
			
			console.log("[Group] update: " + event);
		}

		function groupChatEnded(){
			enabling("groupChatButton");
			disabling("quitGroupChat");
			disabling("sendGroupMsg");
			updateclientStatus("Group chat terminated !");
		}
		///////////////////////////////////////////////File Transfer///////////////////////////////////////////////////////////		

		var sendFile = document.getElementById("sendFile");
		var fileProgress = document.getElementById("fileProgress");
		var transferNotification = document
				.getElementById("transferNotification");
		var downloadFile = document.getElementById("downloadFile");
		var cancelFile = document.getElementById("cancelFile");
		var downloadedFile = document.getElementById("downloadedFile");
		var fileTransfer = null;

		fileMedia.onchange = function(e) {
			disabling("sendMedia");
			disabling("sendFile");
			var aMedia = fileMedia.files[0];
			if (fileMedia.value == "") {
				return;
			}

			var aMediaSize = aMedia.size;
			if (aMediaSize < 51200 && aMedia.type.indexOf("image") != -1) {
				enabling("sendMedia");
			}

			if (aMediaSize < 1500000) {
				enabling("sendFile");
			}
		}

		sendFile.onclick = function() {
			if (callRecipient.value == ""
					|| callRecipient.value == callRecipient.defaultValue) {
				updateclientStatus("Transfer address is missing, friend is only an example");
				clientStatus.className = "errorStatus";
				return;
			}

			if (fileMedia.value == "") {
				updateclientStatus("Please choose a file for transfer");
				clientStatus.className = "errorStatus";
				return;
			}

			if (fileMedia.files[0].size >= 1500000) {
				updateclientStatus("File size should be less than 1.5MB");
				clientStatus.className = "errorStatus";
				return;
			}

			fileTransfer = service.createFileTransfer(callRecipient.value);
			fileTransfer.onstatechange = ftpOnStateChange;
			fileTransfer.onerror = ftpOnError;
			fileTransfer.onuploadprogress = ftpOnUploadProgress;
			fileTransfer.sendFile(fileMedia.files[0]);

			updateclientStatus("Sending file \"" + fileMedia.value + "\"");
			fileMedia.value = "";
			disabling("sendMedia");
			disabling("sendFile");
			fileProgress.value = 0;
		}

		ftpOnUploadProgress = function(event) {
			fileProgress.style.opacity = 1;
			fileProgress.max = event.total;
			fileProgress.value = event.loaded;
			if (event.loaded / event.total == 1) {
				updateclientStatus("Upload completed !");
				fileProgress.style.opacity = 0;
			}
		}

		ftpOnDownloadProgress = function(event) {
			fileProgress.style.opacity = 1;
			fileProgress.max = event.total;
			fileProgress.value = event.loaded;
			if (event.loaded / event.total == 1) {
				updateclientStatus("Download completed !");
				fileProgress.style.opacity = 0;
			}
		}

		ftpOnReceivedFile = function(event) {
		 var src = event.ftp.data;
		 downloadedFile.href= src;
		 downloadedFile.style.visibility= "";
		 
		 //if (event.ftp.type.search("image") != -1) {
		 //$("#progressbar" + this._id).html(this.name + '<img style="float:right" src="' + src + '" height="33px" width="33px"/><br /><a href="' + src + '" target="_blank">Open</a>');
		 //} else {
		 //$("#progressbar" + this._id).html(this.name + '<img style="float:right" src="images/fileIconGeneric.png" width="33px"/><br /><a href="' + src +'" target="_blank">Open</a>');
		}
		
		
		ftpOnStateChange = function(event) {
			console.log("[FileTransfer] State changed: " + event.type + " "
					+ event.state);

			if (event.state == FileTransfer.State.CANCELED) {
				updateclientStatus("File transfer aborted !");
				fileProgress.style.opacity = 0;
			}
		}

		ftpOnError = function(event) {
			console.log("[FileTransfer] Error: " + event.reason);
			updateclientStatus("File transfer failure !");
			fileProgress.style.opacity = 0;
		}

		/////////////////////////////////////////////// Dial-out Media Conf ////////////////////////////////////////////////////		
		var mediaConfNotification = document.getElementById("mediaConfNotification");
		var createMediaConf = document.getElementById("createMediaConf");
		var createAudioMediaConf = document.getElementById("createAudioMediaConf");
		var inviteParticipant = document.getElementById("inviteParticipant");
		var mediaConfTable = document.getElementById("mediaConfTable");
		var removeParticipant= document.getElementById("removeParticipant");
		
		createMediaConf.onclick = function() {
			call = service.createConference({
				audio : true,
				video : true
			});
			call.onaddstream = confOnAddStream;
			call.onbegin = confOnBegin;
			call.onend = confOnEnd;
			call.onerror = confOnError;
			call.onremovestream = confOnRemoveStream;
			call.onstatechange = confOnStateChange;
			call.onjoin = confOnJoin;
			call.onleave = confOnLeave;

			// Starts the conference, and automatically joins it (moderator)
			call.begin();
			updateclientStatus("Creating conference...");
			enabling("quitMediaConf");
			disablingCreateCall();
		}
		
		//Starts an audio only Dial Out Conference
		createAudioMediaConf.onclick = function() {
			call = service.createConference({
				audio : true
			});
			call.onaddstream = confOnAddStream;
			call.onbegin = confOnBegin;
			call.onend = confOnEnd;
			call.onerror = confOnError;
			call.onremovestream = confOnRemoveStream;
			call.onstatechange = confOnStateChange;
			call.onjoin = confOnJoin;
			call.onleave = confOnLeave;

			// Starts the conference, and automatically joins it (moderator)
			call.begin();
			updateclientStatus("Creating audio conference...");
			enabling("quitMediaConf");
			disablingCreateCall();
		}

		quitMediaConf.onclick = function() {
			quitConf.onclick();
		};
		
		inviteParticipant.onclick = function() {
			if (participantToInvite.value != ""	&& participantToInvite.value != participantToInvite.defaultValue) {
				call.addUser(participantToInvite.value, function(evt) {
					if (evt.success) {
						updateclientStatus("Added participant successfully.");
						enabling("removeParticipant");
					} else if (evt.failure) {
						updateclientStatusError("Fail to add participant!");
					}});
				participantAdded(participantToInvite.value);
				participantToInvite.value= "";
			} else {
				updateclientStatusError("Cannot add participant missing value.");
				clientStatus.className = "errorStatus";
			}
		}
		
		removeParticipant.onclick = function(id) {
			var toRemove= getSelectedParticipant();			
			for(var i=toRemove.length-1; i>=0; i--) {
				var num= toRemove[i];
				call.removeUser(mediaConfTable.rows[num].cells[1].innerHTML);
				mediaConfTable.deleteRow(num);			
			}
		}	

		function getSelectedParticipant(all) {
			all= typeof all !== 'undefined' ? all : false;			
			var toRemove= new Array();
			for(var i=0; i<mediaConfTable.rows.length; i++) {
				if(mediaConfTable.rows[i].id.indexOf("participant-") == 0)
				{
					var chkbox= mediaConfTable.rows[i].cells[0].childNodes[0];
					if(all || chkbox.checked){
						toRemove.push(i);
					}
				}
			}
			return toRemove;
		}
		
		function removeAllParticipant() {
			var toRemove= getSelectedParticipant(true);			
			for(var i=toRemove.length-1; i>=0; i--) {
				mediaConfTable.deleteRow(toRemove[i]);			
			}
		}	

		function participantAdded(value) {

            var rowCount = mediaConfTable.rows.length;
            var row = mediaConfTable.insertRow(rowCount);
			row.setAttribute('id','participant-' + rowCount);
            var cell1 = row.insertCell(0);
			cell1.setAttribute('style','width: 25px;');
            var element1 = document.createElement("input");
            element1.type = "checkbox";
            cell1.appendChild(element1);
            var cell2 = row.insertCell(1);
            cell2.innerHTML = value;
        }
		
		function disablingCreateCall() {
			disabling("calling");
			disabling("voiceCalling");
			disabling("connectConf");
			disabling("createConf");
			disabling("createMediaConf");
			disabling("createAudioMediaConf");
		}

		function enablingCreateCall() {
			enabling("calling");
			enabling("voiceCalling");
			enabling("connectConf");
			enabling("createConf");
			enabling("createMediaConf");
			enabling("createAudioMediaConf");
		}

		function disablingCallAction() {
			removeAllParticipant();			
			disabling("quitConf");
			disabling("quitMediaConf");
			disabling("endCall");
			disabling("inviteParticipant")
			disabling("removeParticipant");
			disabling("holdCall");
			disabling("resumeCall");
			disabling("transferCall");
		}
		
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				

		/************************************************************************
		 * Service handlers below												*
		 ***********************************************************************/

		function serviceOnReady(event) {
			updateclientStatus("Registered !");
			enabling("unregister");
			disabling("register");
			enablingCreateCall();
			enabling("sendMsg");
			enabling("sendIM");
			enabling("groupChatButton");
			enabling("fileMedia");
			console.log("[MediaServices] Ready");
		}

		sendIM.onclick = function() {
			var msg = message.value;
			if (msg == "") {
				updateclientStatusError("IM missing message !");
			} else if (callRecipient.value == "" || callRecipient.value == callRecipient.defaultValue) {
				updateclientStatusError("IM missing recipient !");
			} else {
				chatText.value += "Sent IM to ("+ callRecipient.value + "): "+ msg + "\n";
				chatText.scrollTop = chatText.scrollHeight;
				service.sendIM(callRecipient.value, msg);
				message.value = "";
				updateclientStatus("IM sent !");
				message.focus();
			}
		};
		
		function serviceOnIM(event) {
			updateclientStatus("Received InstantMessage !");
			chatText.value += "Received IM from ("+ event.from + "): "+ event.message + "\n";
		}

		function serviceOnStateChange(event) {
			console.log("[MediaServices] State changed: " + event.type + " "
					+ event.state);
		}

		function serviceOnClose(event) {
			updateclientStatus("Offline !");
			clientStatus.className = "offlineStatus";
			console.log("[MediaServices] Closed");
		}

		function serviceOnError(event) {
			updateclientStatusError("Error !");
			console.log("[MediaServices] Error: " + event.type + " "
					+ event.reason + " " + event.target);
		}

		function addNotification(elem) {
			elem.setAttribute("bgcolor", "darkviolet");
			elem.style.opacity = 1;
		}

		function removeNotification(elem) {
			elem.removeAttribute("bgcolor");
			elem.style.opacity = 0;
		}

		function serviceOnInvite(event) {
			console.log("receive event" + event);
			if (event.call) {
				console.log("[MediaServices] Received call invite");
				updateclientStatus("Receiving call... Accept/Reject?");
				disabling("voiceCalling");
				disabling("calling");
				enabling("endCall");
				enabling("rejectCall");
				enabling("acceptCall");
				callRecipient.value = event.call.recipient;				
				call = event.call;
				call.onend = callOnEnd;
				
				addNotification(callNotification);
				acceptCall.onclick = function() {
					call = event.call;
					call.answer();
					call.onaddstream = callOnAddStream;
					call.onbegin = callOnBegin;
					call.onend = callOnEnd;
					call.onerror = callOnError;
					call.onremovestream = callOnRemoveStream;
					call.onstatechange = callOnStateChange;
					updateclientStatus("Accepting call.");
					disabling("acceptCall");
					removeNotification(callNotification);
				};

				rejectCall.onclick = function() {
					updateclientStatus("Rejecting call.");
					enabling("calling");
					enabling("voiceCalling");
					disabling("endCall");
					disabling("acceptCall");
					disabling("rejectCall");
					event.call.end();
				};
			} else if (event.conf) {
				console.log("[MediaServices] Received conference invite");				
			} else if (event.chat) {
				chat = event.chat;
				createChat(event.chat.from);
			} else if (event.groupChat) {
				
				updateclientStatus(event.groupChat.recipient[0] + " invite you to a group chat... Accept/Decline? ");
				addNotification(groupNotification);
				subject.value= event.groupChat.subject
				participants.value = event.groupChat.recipient;				
				disabling("groupChatButton");				
				groupChat= event.groupChat;

				acceptGroup.onclick = function() {
					updateclientStatus("Connecting to group...");
					removeNotification(groupNotification);
					groupChat.accept();
					groupChat.onbegin = groupchatOnBegin;
					groupChat.onend =   groupchatOnEnd;
					groupChat.ondecline = groupchatOnDecline;
					groupChat.onmessage =   groupchatOnMessage;
					groupChat.oncomposing =   groupchatIsComposing;
					groupChat.onerror =   groupchatOnError;
					groupChat.onstatechange =   groupchatOnStateChange;
					groupChat.onupdate =   groupchatOnUpdate;
					enabling("quitGroupChat");
					groupChatText.value= "";
				};

				declineGroup.onclick = function() {
					removeNotification(groupNotification);
					groupChat.decline();
					groupChat = null;
					enabling("groupChatButton");
					participants.value = "";		
					subject.value="";					
					updateclientStatus("Decline Group invitation !");
				};

						
			} else if (event.ftp) {
				downloadedFile.style.visibility= "hidden";

				fileTransfer = event.ftp;
				fileTransfer.ondownloadprogress = ftpOnDownloadProgress;
				fileTransfer.onreceivedfile = ftpOnReceivedFile;
				fileTransfer.onstatechange = ftpOnStateChange;
				fileTransfer.onerror = ftpOnError;

				updateclientStatus(fileTransfer.from
						+ " is sending a file call \"" + fileTransfer.name
						+ "\" Download/Cancel? ");
				addNotification(transferNotification);

				downloadFile.onclick = function() {
					updateclientStatus("Downloading file...");
					callRecipient.value = fileTransfer.from;
					fileTransfer.accept();
					fileTransfer.ondownloadprogress = ftpOnDownloadProgress;
					fileTransfer.onreceivedfile = ftpOnReceivedFile;
					fileTransfer.onstatechange = ftpOnStateChange;
					fileTransfer.onerror = ftpOnError;
					removeNotification(transferNotification);
				};

				cancelFile.onclick = function() {
					removeNotification(transferNotification);
					fileTransfer.cancel();
					filetransfer = null;
				};
			}
		}
		document.getElementById("login").focus();
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	};
</script>
</head>

<body>
	<!-- Media services -->
	WCG:
	<input id="url" type="text"
		value="https://api.foundry.att.com/a1/webrtc" size="16" />
	<!--<input id="url" type="text" value="http://172.25.11.23:8888/HaikuServlet/rest/v2/" size="40" />-->
	APIG Sim:
	<input id="apig" type="hidden"
		value="206.19.204.53:6161" size="16" />
	STUN:
	<input id="turn" type="text" value="STUN:206.18.171.164:5060" size="19" />	<br> 
	 Web id:&nbsp;<input id="login" type="text" value="DoesNotMatter" onkeydown="if (event.keyCode == 13) document.getElementById('register').click();">&nbsp;
	 Password:&nbsp;<input id="password" type="text" value="DoesNotMatter" size="8" onkeydown="if (event.keyCode == 13) document.getElementById('register').click();">&nbsp;
	 Temporary number:&nbsp;<input id="number" size="9" type="text" value="">
	<br>
	<button id="register">Login</button>
	<button id="unregister" disabled="disabled">Logout</button>
	<button id="genToken" style="margin-left: 186px;"> Generate Token</button>&nbsp;
	 Access Token:&nbsp;<input id="token" type="text" value="YourAccessToken" size="6" onkeydown="if (event.keyCode == 13) document.getElementById('register').click();">
	<br>
	<div id="clientStatus" class="offlineStatus"
		style="border-radius: 6px; width: 590px; height: 18px; margin: 2px; margin-bottom: 4px; padding: 3px; padding-left: 6px;">Offline</div>
		<br>
<hr style="color:black; background-color:darkblue; height: 2px; width:600px; position:absolute; left: 14px; top: 113px;">
	<table id="dialInMediaConfTable">
		<label width="33" style="position: relative; top: 6px; left: 22px; padding: 0px 7px; background-color: white; ">Dial-in Conference</label>
			<tr>
				<td>

	<!-- Conferencing -->
	<button id="createConf" disabled="disabled">Create conference</button>
	<!--  <Conf ID: <input id="confID" type="text" value="" size="55"/><br>
		<button id="joinConf">Create conference & Join</button>
		<button id="addUser">Add user</button>
		<button id="removeUser">Remove user</button>
		<button id="leaveConf">Leave/Reject conference</button>
		<button id="endConf">End conference</button><br />  -->

	<!-- Call -->
	Conference:
	<input id="confRecipient" style="font-size: 10pt;" " type="text"
		size="34" value="Conference Id"
		onclick="javascript: if (this.value=='Conference Id')this.value='';"
		onfocus="javascript: if (confRecipient.defaultValue==confRecipient.value)confRecipient.value = ''"
		onblur="this.value=!this.value?'Conference Id':this.value;">
	<button id="connectConf" disabled="disabled">Connect</button>
	<button id="quitConf" disabled="disabled">Quit</button>
	</td></tr></table>
	<br>
	<!--  <button id="acceptCall">Accept call</button> 
		<button id="endCall">End/Reject call</button><br />-->
	<!--<button id="endConfCall"  disabled="disabled">Quit</button>-->
	<table id="videoWindows" hidden="hidden">
		<tr>
			<!-- position: fixed; top: 4px; left: 616px;  position: fixed; top: 490px; left: 615px; -->
			<td><video id="selfView" width="160" height="120"
					style="opacity: 0; -webkit-transition-property: opacity; -webkit-transition-duration: 2s; border: 1px solid darkblue; border-spacing: 4px; border-radius: 6px; position: relative;left: 470px;top: 174px;"
					muted autoplay></video></td>
			<td><video id="remoteView" width="640" height="480"
					controlbar="none"
					style="opacity: 0; -webkit-transition-property: opacity; -webkit-transition-duration: 2s; border: 1px solid darkblue; border-spacing: 4px; border-radius: 6px;position: relative;left: -170px;z-index:-1"
					muted autoplay></video></td>
		</tr>
	</table>

	<table id="communicationBox">
	<!-- label width="33" style="position: relative; top: 6px; left: 22px; padding: 0px 7px; background-color: white; ">Communication 1-1</label-->
		<tr>
			<td colspan=3>Remote User address:<input id="callRecipient"
				style="font-size: 10pt;" type="text" size="72" value="friend"
				onclick="javascript: if (this.value=='friend')this.value='';"
				onfocus="javascript: if (callRecipient.defaultValue==callRecipient.value)callRecipient.value = ''"
				onblur="this.value=!this.value?'friend':this.value;"><br>
			</td>
		</tr>
		<tr>
			<td td colspan=3>
				<table id="videoVoiceCallTable" style="border: 1px solid black;">
					<label width="33"
						style="position: relative; top: 6px; left: 22px; padding: 0px 7px; background-color: white; ">Video/Voice Call</label>
					<tr>
						<td>
							<button id="calling" disabled="disabled">Video</button>
							<button id="voiceCalling" disabled="disabled">Voice</button>
							<button id="holdCall" disabled="disabled">Hold</button>
							<button id="resumeCall" disabled="disabled">Resume</button>
							<button id="endCall" disabled="disabled">Quit</button>
						</td>
						<td id="callNotification" style="border: 2px solid white; border-spacing: 3px; border-radius: 6px; opacity: 0; text-align:center;">
							<button id="acceptCall" disabled="disabled">Accept</button>
							<button id="rejectCall" disabled="disabled">Reject</button>
						</td>
					</tr>
					<tr>
						<td colspan=2>
							<button id="transferCall" disabled="disabled">Transfer
								to</button> <input id="transferTarget" style="font-size: 10pt;"
							type="text" size="79" disabled="disabled" />
						</td>
					</tr>

				</table>
			</td>
		</tr>
		
		<!--///////////////////////////////////////////// CHAT /////////////////////////////////////////////////////////////// -->
		<tr>
			<td td colspan=3>
				<table id="messagingTransferTable" style="border: 1px solid black;">
					<label
						style="position: relative; top: 6px; left: 22px; padding: 0px 7px; background-color: white;">Messaging
						and File Transfer </label>

					<tr>
						<td colspan=3>
							<button id="sendMsg" disabled="disabled">Send Message</button>
							<button id="sendIM" disabled="disabled">Send IM</button> Message:<input
							id="message"
							onkeydown="if (event.keyCode == 13) document.getElementById('sendMsg').click();"
							style="font-size: 10pt;" type="text" size="53" />
						</td>
					</tr>
					<tr>
						<td>Responses:</td>
						<td colspan=2><div id="isComposing">&nbsp;</div></td>
					</tr>
					<tr>
						<td colspan=3><textarea id="chatText" readonly="readonly"
								rows="10" cols="70"></textarea><br /></td>
					</tr>
					<tr>
						<td colspan=2><input type="file" id="fileMedia"
							disabled="disabled"></td>
						<td rowspan=3 align="right">
							<table>
								<tr>
									<th
										style="border-right: solid 15px transparent; font-size: 13px; color: dimgrey;">Image
										Received</th>
								</tr>
								<tr>
									<td><img id="downloadedImg" src="" height="56px"
										width="56px"
										style="visibility: hidden; border: 1px solid lightgray; position: relative; left: 14px;">
									</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<td colspan=2 style="white-space: nowrap; width: 1px;">
							<button id="sendMedia" disabled="disabled">Send small
								image</button>
							<button id="sendFile" disabled="disabled">Send File</button> <progress
								id="fileProgress" max="1000" value="0"
								style="opacity: 0; position: relative; top: 2px; left: 3px; width: 250px; height: 20px;"></progress>
						</td>
					</tr>
					<tr>
						<td><a style="visibility: hidden;" id="downloadedFile"
							href="" target="_blank">Show received file</a></td>
						<td id="transferNotification"
							style="width: 140px; opacity: 0; border: 2px solid white; border-spacing: 3px; border-radius: 6px;">
							<button id="downloadFile">Download</button>
							<button id="cancelFile">Cancel</button>
						</td>
					</tr>
				</table>
			</td>
		</tr>
		</table>
		<!--///////////////////////////////////////////// CHAT /////////////////////////////////////////////////////////////// -->
				
		<!--/////////////////////////////////////////////GROUP CHAT /////////////////////////////////////////////////////////////// -->
		<table id="groupChatBox">
		<label width="33" style="position: relative; top: 6px; left: 22px; padding: 0px 7px; background-color: white; ">Group Chat</label>
			<tr>
				<td>
					<button id="groupChatButton" disabled="disabled">Create</button> Subject: <input id="subject" style="font-size: 10pt;"
					type="text" size="33" value="subject"
					onclick="javascript: if (this.value=='subject')this.value='';"
					onfocus="javascript: if (subject.defaultValue==subject.value)subject.value = ''"
					onblur="this.value=!this.value?'subject':this.value;">
					<button id="quitGroupChat" disabled="disabled">Quit</button>
				</td>
				<td id="groupNotification"
					style="border: 2px solid white; border-spacing: 3px; border-radius: 6px; opacity: 0;">
					<button id="acceptGroup">Accept</button>
					<button id="declineGroup">Decline</button>
				</td>

			</tr>
			<tr>
				<td colspan=2><input id="participants" style="font-size: 10pt;"
					type="text" size="94" value="comma seperated user id"
					onclick="javascript: if (this.value=='comma seperated user id')this.value='';"
					onfocus="javascript: if (participants.defaultValue==participants.value)participants.value = ''"
					onblur="this.value=!this.value?'comma seperated user id':this.value;">
				</td>
			</tr>
			<tr>
				<td colspan=2>
					<button id="sendGroupMsg" disabled="disabled">Send Group
						Message</button> <input id="groupMessage" style="font-size: 10pt;"
					type="text" size="69"
					onkeydown="if (event.keyCode == 13) document.getElementById('sendGroupMsg').click();" /><br>
				</td>
			</tr>
			<tr>
				<td colspan=2><textarea readonly="readonly" id="groupChatText"
						rows="10" cols="72"></textarea></td>
			</tr>
		</table>
		<!--/////////////////////////////////////////////GROUP CHAT /////////////////////////////////////////////////////////////// -->

		<!--///////////////////////////////////////////// DIAL-OUT Conf /////////////////////////////////////////////////////////// -->
		<table id="mediaConfTable">
		<label width="33" style="position: relative; top: 6px; left: 22px; padding: 0px 7px; background-color: white; ">Dial-out Conference</label>
			<tr>
				<td colspan=2>
					<button id="createMediaConf" disabled="disabled">Create Conference</button>
					<button id="createAudioMediaConf" disabled="disabled">Create Audio Only Conference</button>
					<button id="quitMediaConf" disabled="disabled">Quit</button>
				</td>
			</tr>
			<!--tr>
				<td colspan=2 id="mediaConfNotification"
					style="border: 2px solid white; border-spacing: 3px; border-radius: 6px; opacity: 0;">
					<button id="acceptMediaConf">Accept Media Conference</button>
					<button id="declineMediaConf">Decline Media Conference</button>
				</td>
			</tr-->
			<tr>
				<td colspan=2>
					<button id="inviteParticipant" disabled="disabled">Invite
						participant</button> <input id="participantToInvite"
					style="font-size: 10pt;" type="text" size="75"
					onkeydown="if (event.keyCode == 13) document.getElementById('inviteParticipant').click();"
					value="comma seperated user id"
					onclick="javascript: if (this.value=='comma seperated user id')this.value='';"
					onfocus="javascript: if (participants.defaultValue==participants.value)participants.value = ''"
					onblur="this.value=!this.value?'comma seperated user id':this.value;" />
				</td>
			</tr>
			<tr>
				<td colspan=2>
					<button id="removeParticipant" disabled="disabled">Remove participant</button>
				</td>
			</tr>
		</table>
		<br>
		<!--///////////////////////////////////////////// DIAL-OUT Conf /////////////////////////////////////////////////////////// -->
		 <footer>
    <p>Client version: 1.0.4</p>
  </footer>
	</body>
</html>
<!-- sip:16132223361@mcs-emc.ericsson.ca -->





